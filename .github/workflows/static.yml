# Simple workflow for deploying static content to GitHub Pages
name: Deploy static content to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Single deploy job since we're just deploying
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload entire repository
          path: '.'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å±…ä¸Šå®¶å…·ç®¡ç†ç³»ç»Ÿ - åä½œç‰ˆ</title>
  
  <!-- åä½œåŠŸèƒ½ä¾èµ–åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --line: rgba(255,255,255,.08);
      --primary: #6366f1;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --radius: 12px;
      --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background: var(--bg);
      height: 100vh;
      overflow-y: auto;
    }
    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--panel);
      padding: 16px 24px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    .brand h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: #fff;
    }
    .brand span {
      font-size: 12px;
      color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 8px;
    }
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .btn {
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all .2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #334155;
      color: var(--text);
    }
    .btn:hover {
      background: #475569;
    }
    .btn.primary {
      background: var(--primary);
      color: white;
    }
    .btn.primary:hover {
      filter: brightness(1.1);
    }
    .btn.success {
      background: var(--success);
      color: white;
    }
    .btn.success:hover {
      filter: brightness(1.1);
    }
    .btn.danger {
      background: rgba(239,68,68,0.2);
      color: #fca5a5;
    }
    .btn.danger:hover {
      background: rgba(239,68,68,0.3);
    }
    .btn.warning {
      background: rgba(245,158,11,0.2);
      color: #fcd34d;
    }
    .btn.warning:hover {
      background: rgba(245,158,11,0.3);
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .stat-card {
      background: var(--panel);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .stat-label {
      font-size: 13px;
      color: var(--muted);
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
    }
    .stat-card.blue .stat-value {
      color: var(--primary);
    }
    .stat-card.green .stat-value {
      color: var(--success);
    }
    .stat-card.orange .stat-value {
      color: var(--warning);
    }
    .stat-card.red .stat-value {
      color: var(--danger);
    }
    .filter-bar {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      background: var(--panel);
      padding: 12px 20px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
    }
    .search-box {
      position: relative;
      flex: 1;
      max-width: 300px;
    }
    .search-box input {
      width: 100%;
      background: #0f172a;
      border: 1px solid var(--line);
      color: white;
      padding: 8px 12px 8px 32px;
      border-radius: 6px;
      outline: none;
    }
    .search-box::before {
      content: "ğŸ”";
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      opacity: 0.5;
    }
    .category-filters {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 2px;
    }
    .filter-chip {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      border: 1px solid transparent;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .filter-chip:hover {
      background: rgba(255,255,255,0.1);
    }
    .filter-chip.active {
      background: rgba(99, 102, 241, 0.2);
      color: var(--primary);
      border-color: rgba(99, 102, 241, 0.3);
    }
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 3fr 1fr;
      gap: 20px;
    }
    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: var(--panel);
      border-radius: var(--radius);
      border: 1px solid var(--line);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .card-h {
      padding: 16px 20px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-h h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th {
      text-align: left;
      padding: 12px 16px;
      color: var(--muted);
      font-weight: 500;
      border-bottom: 1px solid var(--line);
      white-space: nowrap;
    }
    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      color: var(--text);
    }
    tr:last-child td {
      border-bottom: none;
    }
    tr:hover {
      background: rgba(255,255,255,0.02);
    }
    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      display: inline-block;
    }
    .badge.type-chair { background: #3b82f6; color: white; }
    .badge.type-table { background: #10b981; color: white; }
    .badge.type-sofa { background: #f59e0b; color: white; }
    .badge.type-bed { background: #ef4444; color: white; }
    .badge.type-cabinet { background: #8b5cf6; color: white; }
    .badge.type-bookshelf { background: #06b6d4; color: white; }
    .badge.type-teatable { background: #f97316; color: white; }
    .badge.type-officechair { background: #84cc16; color: white; }
    .badge.type-diningtable { background: #10b981; color: white; }
    .badge.type-tvstand { background: #64748b; color: white; }
    .badge.status-0 { background: #ef4444; color: white; }
    .badge.status-50 { background: #f59e0b; color: white; }
    .badge.status-100 { background: #10b981; color: white; }
    .progress-track {
      width: 100px;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 4px;
    }
    .progress-fill {
      height: 100%;
      transition: width 0.3s ease;
    }
    .progress-fill.red { background: var(--danger); }
    .progress-fill.orange { background: var(--warning); }
    .progress-fill.green { background: var(--success); }
    .thumb {
      width: 64px;
      height: 48px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid var(--line);
      cursor: pointer;
      display: inline-block;
      background: rgba(255,255,255,0.06);
    }
    .img-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    #imgPreviewDlg::backdrop { background: rgba(0,0,0,.6); }
    #imgPreview {
      width: min(960px, 90vw);
      max-height: 75vh;
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
    }
    select {
      background: #0f172a;
      border: 1px solid var(--line);
      color: white;
      padding: 6px 8px;
      border-radius: 6px;
      outline: none;
      width: 100%;
      font-size: 13px;
    }
    select:focus {
      border-color: var(--primary);
    }
    .log {
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
    }
    .logitem {
      padding: 8px 0;
      border-bottom: 1px solid var(--line);
    }
    .logitem:last-child {
      border-bottom: none;
    }
    .logitem .head {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .logitem .msg {
      font-size: 13px;
      color: var(--text);
    }
    .logitem .who {
      font-size: 11px;
      color: var(--muted);
    }
    #importDlg {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      color: var(--text);
      max-width: 500px;
      width: 90%;
    }
    #importDlg::backdrop {
      background: rgba(0,0,0,.6);
    }
    .dlg-h {
      padding: 16px 20px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .dlg-h h3 {
      margin: 0;
      font-size: 16px;
    }
    .dlg-b {
      padding: 20px;
    }
    .drop {
      border: 2px dashed var(--line);
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
    }
    .drop:hover {
      border-color: var(--primary);
    }
    .row {
      margin-bottom: 10px;
    }
    .muted {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
    }
    input[type="file"] {
      width: 100%;
      padding: 10px;
      background: #0f172a;
      border: 1px solid var(--line);
      border-radius: 6px;
      color: var(--text);
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    textarea {
      background: #0f172a;
      border: 1px solid var(--line);
      color: white;
      padding: 6px 8px;
      border-radius: 4px;
      outline: none;
      width: 100%;
      font-size: 13px;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    textarea:focus,
    select:focus {
      border-color: var(--primary);
    }
    textarea {
      resize: both;
      min-height: 60px;
      min-width: 150px;
      max-width: 400px;
      max-height: 200px;
      overflow: auto;
    }
    .row-actions {
      display: flex;
      gap: 6px;
    }
    .row-actions .btn {
      padding: 4px 8px;
      font-size: 12px;
    }
    .save-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    .save-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }
    .unsaved-warning {
      background: var(--warning);
    }
    .folder-info {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .folder-icon {
      font-size: 14px;
    }
    .folders-sidebar {
      min-width: 200px;
    }
    .folders-list {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .folder-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }
    .folder-item:hover {
      background: rgba(255,255,255,0.05);
    }
    .folder-item.active {
      background: rgba(99, 102, 241, 0.2);
      border-left: 3px solid var(--primary);
    }
    .folder-name {
      font-size: 13px;
      font-weight: 500;
    }
    .folder-count {
      font-size: 11px;
      background: rgba(255,255,255,0.1);
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }
    .delete-folder-btn {
      background: rgba(239,68,68,0.2);
      color: #fca5a5;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
      transition: all 0.2s;
    }
    .delete-folder-btn:hover {
      background: rgba(239,68,68,0.4);
      opacity: 1;
    }
    .folder-item:hover .delete-folder-btn {
      opacity: 1;
    }
    .folder-actions {
      display: flex;
      gap: 4px;
    }
    .folder-actions .btn {
      padding: 2px 6px;
      font-size: 11px;
    }
    .folders-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--line);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .folders-header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }
    #newFolderDlg {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      color: var(--text);
      max-width: 400px;
      width: 90%;
    }
    #newFolderDlg::backdrop {
      background: rgba(0,0,0,.6);
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    .form-control {
      width: 100%;
      padding: 8px 12px;
      background: #0f172a;
      border: 1px solid var(--line);
      border-radius: 6px;
      color: white;
      font-size: 14px;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
    }
    .dialog-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 20px;
    }
    .batch-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }
    .batch-select-all {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    .checkbox-cell {
      width: 40px;
      text-align: center;
    }
    .checkbox-cell input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    .camera-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .camera-btn:hover {
      filter: brightness(1.1);
    }
    #cameraDlg {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      color: var(--text);
      max-width: 600px;
      width: 90%;
    }
    #cameraDlg::backdrop {
      background: rgba(0,0,0,.9);
    }
    .camera-container {
      position: relative;
      width: 100%;
      height: 400px;
      overflow: hidden;
      border-radius: 8px;
      background: #000;
    }
    #cameraPreview {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .camera-controls {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 16px;
    }
    .camera-btn.capture {
      background: var(--success);
    }
    .camera-btn.cancel {
      background: var(--danger);
    }
    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      .folders-sidebar {
        order: -1;
      }
      .controls {
        flex-wrap: wrap;
      }
      .btn {
        padding: 6px 12px;
        font-size: 12px;
      }
    }
    .quantity-input {
      width: 80px !important;
      min-width: 80px !important;
      max-width: 120px !important;
    }
    
    /* åä½œç›¸å…³æ ·å¼ */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      background: var(--panel);
      border: 1px solid var(--line);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .notification.info {
      border-left: 4px solid var(--primary);
    }
    
    .notification.warning {
      border-left: 4px solid var(--warning);
    }
    
    .notification.success {
      border-left: 4px solid var(--success);
    }
    
    .notification.danger {
      border-left: 4px solid var(--danger);
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
    }
    
    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px;
      min-width: 200px;
      display: none;
      margin-top: 8px;
    }
    
    .user-menu:hover .user-dropdown {
      display: block;
    }
    
    .online-status {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    .online-status.online {
      background: var(--success);
    }
    
    .online-status.offline {
      background: var(--danger);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- é¡¶æ  - æ·»åŠ ç”¨æˆ·æ§ä»¶ -->
    <div class="topbar">
      <div class="brand">
        <h1>å±…ä¸Šå®¶å…·ç®¡ç†ç³»ç»Ÿ</h1>
        <span>åä½œç‰ˆ</span>
      </div>
      
      <div class="controls">
        <!-- ç”¨æˆ·èœå• -->
        <div class="user-menu" id="userMenu" style="display:none">
          <div class="user-avatar" id="userAvatar">?</div>
          <div class="user-dropdown">
            <div style="padding: 8px 12px; border-bottom: 1px solid var(--line);">
              <div id="userEmail"></div>
              <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">
                çŠ¶æ€: <span id="userStatus">ç¦»çº¿</span>
              </div>
            </div>
            <button class="btn" onclick="window.collaborationManager?.logout()" 
                    style="width:100%; margin-top:8px">é€€å‡ºç™»å½•</button>
          </div>
        </div>    
     <!-- ç™»å½•æŒ‰é’® -->
        <button class="btn primary" id="loginBtn" onclick="collaborationManager?.loginWithGitHub()">
          ç™»å½•ä»¥åä½œ
        </button>
    
    <button class="btn primary" onclick="addNewProject()">+ æ–°å»ºé¡¹ç›®</button>
        <button class="btn success" onclick="saveCurrentFolder()">ä¿å­˜å½“å‰æ–‡ä»¶å¤¹</button>
        <button class="btn" onclick="exportJSON()">å¯¼å‡ºJSON</button>
        <button class="btn primary" onclick="showImport()">å¯¼å…¥Excel</button>
      </div>
    </div>

    <!-- æ•°æ®çœ‹æ¿ -->
    <div class="stats-grid">
      <div class="stat-card blue">
        <div class="stat-label">æ€»é¡¹ç›®æ•°</div>
        <div class="stat-value" id="total">0</div>
      </div>
      <div class="stat-card green">
        <div class="stat-label">å·²å®Œæˆ</div>
        <div class="stat-value" id="completed">0</div>
      </div>
      <div class="stat-card orange">
        <div class="stat-label">è¿›è¡Œä¸­</div>
        <div class="stat-value" id="inProgress">0</div>
      </div>
      <div class="stat-card red">
        <div class="stat-label">å»¶æœŸé¡¹ç›®</div>
        <div class="stat-value" id="overdue">0</div>
      </div>
    </div>

    <!-- ç­›é€‰å·¥å…·æ  -->
    <div class="filter-bar">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="æœç´¢å®¢æˆ·åã€ç¼–å·æˆ–ç±»å‹" oninput="handleSearch()">
      </div>
      <div class="category-filters" id="typeFilters"></div>
      <button class="btn" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
    </div>

    <!-- ä¸»ä½“å†…å®¹ -->
    <div class="main-grid">
      <!-- æ–‡ä»¶å¤¹ä¾§è¾¹æ  -->
      <div class="folders-sidebar">
        <div class="card">
          <div class="folders-header">
            <h3>é¡¹ç›®æ–‡ä»¶å¤¹</h3>
            <button class="btn primary" onclick="showNewFolderDialog()" style="padding: 4px 8px; font-size: 12px;">+ æ–°å»º</button>
          </div>
          <div class="folders-list" id="foldersList"></div>
        </div>
      </div>

      <!-- é¡¹ç›®åˆ—è¡¨ -->
      <div>
        <div class="card">
          <div class="card-h">
            <h2 id="currentFolderTitle">æ‰€æœ‰é¡¹ç›®</h2>
            <div class="controls">
              <button class="btn" onclick="exportTableToExcel()">å¯¼å‡ºExcel</button>
            </div>
          </div>
          <div class="card-b">
            <!-- æ‰¹é‡æ“ä½œæ  -->
            <div class="batch-actions" id="batchActions" style="display:none; padding: 10px 20px;">
              <div class="batch-select-all">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                <label for="selectAll">å…¨é€‰</label>
              </div>
              <span id="selectedCount">å·²é€‰æ‹© 0 ä¸ªé¡¹ç›®</span>
              <button class="btn danger" id="batchDeleteBtn" onclick="batchDeleteProjects()" style="display:none;">æ‰¹é‡åˆ é™¤</button>
            </div>
            
            <div class="table-container">
              <table id="projectTable">
                <thead>
                  <tr>
                    <th class="checkbox-cell">
                      <input type="checkbox" id="headerCheckbox" onchange="toggleHeaderCheckbox()">
                    </th>
                    <th>é¡¹ç›®ç¼–å·</th>
                    <th>å®¢æˆ·åç§°</th>
                    <th>å®¶å…·ç±»å‹</th>
                    <th>æ•°é‡</th>
                    <th>è¿›åº¦</th>
                    <th>è¿›åº¦å›¾ç‰‡</th>
                    <th>äº¤è´§æ—¥æœŸ</th>
                    <th>å¤‡æ³¨</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- å˜æ›´è®°å½• -->
      <div>
        <div class="card">
          <div class="card-h">
            <h2>å˜æ›´è®°å½•</h2>
            <button class="btn" onclick="clearLog()" style="padding: 4px 8px; font-size: 11px;">æ¸…ç©º</button>
          </div>
          <div class="card-b">
            <div class="log" id="log"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¯¼å…¥å¯¹è¯æ¡† -->
  <dialog id="importDlg">
    <div class="dlg-h">
      <h3>å¯¼å…¥Excelæ–‡ä»¶åˆ°æ–‡ä»¶å¤¹</h3>
      <button class="btn" onclick="this.closest('dialog').close()" style="padding:4px 8px">âœ•</button>
    </div>
    <div class="dlg-b">
      <div class="form-group">
        <label for="importFolderSelect">é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹ï¼š</label>
        <select id="importFolderSelect" class="form-control">
          <option value="">-- è¯·é€‰æ‹©æ–‡ä»¶å¤¹ --</option>
        </select>
      </div>
      <div class="drop" id="dropZone">
        <div class="row">
          <input type="file" id="fileInput" accept=".xlsx,.xls" />
        </div>
        <div class="muted" style="margin-top:10px">
          æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼<br/>
          æ–‡ä»¶å°†ä»…åœ¨æœ¬åœ°å¤„ç†ï¼Œä¸ä¼šä¸Šä¼ æœåŠ¡å™¨<br/>
          <br/><strong>æ”¯æŒçš„å­—æ®µåç§°ï¼š</strong><br/>
          é¡¹ç›®ç¼–å·ã€é¡¹ç›®åºå·ã€åºå·ã€ç¼–å·ã€å®¢æˆ·åç§°ã€å®¢æˆ·ã€å®¶å…·ç±»å‹ã€ç±»å‹ã€æ•°é‡ã€è¿›åº¦ã€äº¤è´§æ—¥æœŸã€æˆªæ­¢æ—¥æœŸã€å¤‡æ³¨ã€è¯´æ˜
        </div>
      </div>
    </div>
  </dialog>

  <!-- æ–°å»ºæ–‡ä»¶å¤¹å¯¹è¯æ¡† -->
  <dialog id="newFolderDlg">
    <div class="dlg-h">
      <h3>æ–°å»ºæ–‡ä»¶å¤¹</h3>
      <button class="btn" onclick="this.closest('dialog').close()" style="padding:4px 8px">âœ•</button>
    </div>
    <div class="dlg-b">
      <div class="form-group">
        <label for="folderName">æ–‡ä»¶å¤¹åç§°ï¼š</label>
        <input type="text" id="folderName" class="form-control" placeholder="ä¾‹å¦‚ï¼šAé¡¹ç›®ã€Bé¡¹ç›®ç­‰" />
      </div>
      <div class="form-group">
        <label for="folderDescription">æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š</label>
        <textarea id="folderDescription" class="form-control" rows="3" placeholder="æ–‡ä»¶å¤¹æè¿°..."></textarea>
      </div>
      <div class="dialog-footer">
        <button class="btn" onclick="this.closest('dialog').close()">å–æ¶ˆ</button>
        <button class="btn primary" onclick="createNewFolder()">åˆ›å»º</button>
      </div>
    </div>
  </dialog>

  <!-- å›¾ç‰‡é¢„è§ˆå¯¹è¯æ¡† -->
  <dialog id="imgPreviewDlg">
    <div class="dlg-h">
      <h3>è¿›å±•å›¾ç‰‡é¢„è§ˆ</h3>
      <button class="btn" onclick="this.closest('dialog').close()" style="padding:4px 8px">âœ•</button>
    </div>
    <div class="dlg-b">
      <img id="imgPreview" alt="è¿›å±•å›¾ç‰‡" />
      <div class="muted" id="imgPreviewMeta" style="margin-top:10px"></div>
    </div>
  </dialog>

  <!-- æ‹ç…§å¯¹è¯æ¡† -->
  <dialog id="cameraDlg">
    <div class="dlg-h">
      <h3>æ‹ç…§ä¸Šä¼ </h3>
      <button class="btn" onclick="closeCamera()" style="padding:4px 8px">âœ•</button>
    </div>
    <div class="dlg-b">
      <div class="camera-container">
        <video id="cameraPreview" autoplay playsinline></video>
        <canvas id="cameraCanvas" style="display:none"></canvas>
      </div>
      <div class="camera-controls">
        <button class="camera-btn cancel" onclick="closeCamera()">å–æ¶ˆ</button>
        <button class="camera-btn capture" onclick="capturePhoto()">æ‹ç…§</button>
      </div>
    </div>
  </dialog>

  <!-- ä¿å­˜æç¤º -->
  <div class="save-indicator" id="saveIndicator"></div>

<!-- Excelå¤„ç†åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // æ ¸å¿ƒæ•°æ®ç»“æ„
    let folders = []; // æ–‡ä»¶å¤¹åˆ—è¡¨
    let projects = []; // æ‰€æœ‰é¡¹ç›®
    let log = []; // å˜æ›´è®°å½•
    let currentFolderId = ''; // å½“å‰é€‰ä¸­çš„æ–‡ä»¶å¤¹IDï¼ˆç©ºè¡¨ç¤ºæ‰€æœ‰é¡¹ç›®ï¼‰
    let channel = new BroadcastChannel('furniture_system');
    let currentFilterType = '';
    let currentSearch = '';
    let unsavedChanges = new Set();
    let selectedProjects = new Set(); // æ‰¹é‡é€‰æ‹©çš„é¡¹ç›®ID
    let currentCameraProject = null; // å½“å‰æ‹ç…§çš„é¡¹ç›®

    // é¡¹ç›®ç¼–å·å…³é”®å­—æ˜ å°„
    const PROJECT_ID_KEYWORDS = ['é¡¹ç›®ç¼–å·', 'é¡¹ç›®åºå·', 'åºå·', 'ç¼–å·', 'é¡¹ç›®å·', 'é¡¹ç›®ç¼–ç '];
    const CUSTOMER_KEYWORDS = ['å®¢æˆ·åç§°', 'å®¢æˆ·', 'å®¢æˆ·å', 'è”ç³»äºº'];
    const TYPE_KEYWORDS = ['å®¶å…·ç±»å‹', 'ç±»å‹', 'äº§å“ç±»å‹', 'å®¶å…·ç±»åˆ«', 'äº§å“', 'ç‰©å“', 'è´§ç‰©åç§°', 'åç§°'];
    const QUANTITY_KEYWORDS = ['æ•°é‡', 'ä»¶æ•°', 'ä¸ªæ•°', 'æ•°é‡(ä¸ª)'];
    const PROGRESS_KEYWORDS = ['è¿›åº¦', 'å®Œæˆè¿›åº¦', 'è¿›åº¦ç™¾åˆ†æ¯”', 'å®Œæˆç‡'];
    const DEADLINE_KEYWORDS = ['äº¤è´§æ—¥æœŸ', 'æˆªæ­¢æ—¥æœŸ', 'äº¤ä»˜æ—¥æœŸ', 'å®Œæˆæ—¥æœŸ', 'æœŸé™'];
    const NOTES_KEYWORDS = ['å¤‡æ³¨', 'è¯´æ˜', 'æè¿°', 'å¤‡æ³¨è¯´æ˜'];

    // åä½œç®¡ç†å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
    class CollaborationManager {
      constructor() {
        this.supabase = null;
        this.currentUser = null;
        this.isOnline = navigator.onLine;
        
        // åˆå§‹åŒ–ç½‘ç»œçŠ¶æ€ç›‘å¬
        window.addEventListener('online', () => this.handleOnline());
        window.addEventListener('offline', () => this.handleOffline());
        
        // åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢
        this.initUI();
      }
      
      async initialize() {
        try {
          // åˆå§‹åŒ–Supabase
          this.supabase = window.supabase.createClient(
            'https://ajvegyuzfpauolqhvxyt.supabase.co',  // æ›¿æ¢ä¸ºæ‚¨çš„Supabase URL
            'sb_publishable_N2Hvm3PQACCYJmdI9kq5fg_7pMkbiYl'  // æ›¿æ¢ä¸ºæ‚¨çš„Supabase Anon Key
          );
          
          // åˆå§‹åŒ–Netlify Identity
          if (window.netlifyIdentity) {
            window.netlifyIdentity.init();
            
            window.netlifyIdentity.on('init', user => {
              this.handleUserChange(user);
            });
            
            window.netlifyIdentity.on('login', user => {
              this.handleUserChange(user);
              window.netlifyIdentity.close();
            });
            
            window.netlifyIdentity.on('logout', () => {
              this.handleUserChange(null);
            });
          }
          
          console.log('åä½œæ¨¡å—åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
          console.error('åä½œæ¨¡å—åˆå§‹åŒ–å¤±è´¥:', error);
        }
      }
      
      handleUserChange(user) {
        this.currentUser = user;
        this.updateUserUI();
        
        if (user) {
          this.showNotification(`æ¬¢è¿ï¼Œ${user.email}`, 'success');
          // å¼€å§‹åŒæ­¥æ•°æ®
          this.syncData();
        }
      }
      
      updateUserUI() {
        const userMenu = document.getElementById('userMenu');
        const loginBtn = document.getElementById('loginBtn');
        const userAvatar = document.getElementById('userAvatar');
        const userEmail = document.getElementById('userEmail');
        const userStatus = document.getElementById('userStatus');
        
        if (this.currentUser) {
          // ç”¨æˆ·å·²ç™»å½•
          userMenu.style.display = 'block';
          loginBtn.style.display = 'none';
          
          // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
          const email = this.currentUser.email || '';
          userAvatar.textContent = email.charAt(0).toUpperCase();
          userEmail.textContent = email;
          userStatus.textContent = this.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿';
        } else {
          // ç”¨æˆ·æœªç™»å½•
          userMenu.style.display = 'none';
          loginBtn.style.display = 'inline-flex';
        }
      }
      
      async loginWithGitHub() {
        if (window.netlifyIdentity) {
          window.netlifyIdentity.open('login');
        }
      }
      
      async logout() {
        if (window.netlifyIdentity) {
          window.netlifyIdentity.logout();
        }
      }
      
      handleOnline() {
        this.isOnline = true;
        this.updateUserUI();
        this.showNotification('ç½‘ç»œå·²æ¢å¤', 'success');
        
        // é‡æ–°åŒæ­¥æ•°æ®
        if (this.currentUser) {
          this.syncData();
        }
      }
      
      handleOffline() {
        this.isOnline = false;
        this.updateUserUI();
        this.showNotification('ç½‘ç»œå·²æ–­å¼€ï¼Œæ­£åœ¨ä½¿ç”¨ç¦»çº¿æ¨¡å¼', 'warning');
      }
      
      async syncData() {
        if (!this.supabase || !this.currentUser) return;
        
        try {
          // è¿™é‡Œæ·»åŠ æ‚¨çš„æ•°æ®åŒæ­¥é€»è¾‘
          console.log('å¼€å§‹åŒæ­¥æ•°æ®...');
          
          // ç¤ºä¾‹ï¼šè·å–ç”¨æˆ·çš„é¡¹ç›®æ•°æ®
          const { data: projects, error } = await this.supabase
            .from('projects')
            .select('*')
            .eq('owner_id', this.currentUser.id);
          
          if (error) throw error;
          
          console.log('åŒæ­¥å®Œæˆï¼Œè·å–åˆ°', projects?.length || 0, 'ä¸ªé¡¹ç›®');
          
        } catch (error) {
          console.error('æ•°æ®åŒæ­¥å¤±è´¥:', error);
        }
      }
      
      showNotification(message, type = 'info') {
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
          <span>${message}</span>
          <button onclick="this.parentElement.remove()" style="
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 16px;
          ">Ã—</button>
        `;
        
        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(notification);
        
        // 5ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 5000);
      }
      
      initUI() {
        // æ·»åŠ ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨
        const statusIndicator = document.createElement('div');
        statusIndicator.id = 'networkStatus';
        statusIndicator.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 8px 12px;
          background: ${this.isOnline ? 'var(--success)' : 'var(--danger)'};
          color: white;
          border-radius: 20px;
          font-size: 12px;
          display: flex;
          align-items: center;
          gap: 6px;
          z-index: 1000;
        `;
        statusIndicator.innerHTML = `
          <div class="online-status ${this.isOnline ? 'online' : 'offline'}"></div>
          ${this.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}
        `;
        document.body.appendChild(statusIndicator);
        
        // æ›´æ–°ç½‘ç»œçŠ¶æ€
        setInterval(() => {
          const indicator = document.getElementById('networkStatus');
          if (indicator) {
            indicator.innerHTML = `
              <div class="online-status ${this.isOnline ? 'online' : 'offline'}"></div>
              ${this.isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}
            `;
            indicator.style.background = this.isOnline ? 'var(--success)' : 'var(--danger)';
          }
        }, 1000);
      }
    }
    
    // åä½œç®¡ç†å™¨å®ä¾‹
    let collaborationManager;

    function loadData() {
      // åŠ è½½æ–‡ä»¶å¤¹æ•°æ®
      const savedFolders = localStorage.getItem('furniture_folders');
      if (savedFolders) {
        folders = JSON.parse(savedFolders);
      } else {
        // åˆ›å»ºé»˜è®¤æ–‡ä»¶å¤¹
        folders = [
          {
            id: 'default',
            name: 'é»˜è®¤æ–‡ä»¶å¤¹',
            description: 'ç³»ç»Ÿé»˜è®¤æ–‡ä»¶å¤¹',
            created: new Date().toISOString(),
            projectCount: 0
          }
        ];
        saveFolders();
      }
      
      // åŠ è½½é¡¹ç›®æ•°æ®
      const savedProjects = localStorage.getItem('furniture_projects');
      if (savedProjects) {
        projects = JSON.parse(savedProjects);
        // æ›´æ–°æ–‡ä»¶å¤¹é¡¹ç›®è®¡æ•°
        updateFolderProjectCounts();
      } else {
        addSampleData();
      }
      
      addLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    }

    function saveFolders() {
      localStorage.setItem('furniture_folders', JSON.stringify(folders));
    }

    function saveProjects() {
      localStorage.setItem('furniture_projects', JSON.stringify(projects));
      channel.postMessage({ type: 'update', folders, projects });
    }

    function saveCurrentFolder() {
      if (currentFolderId) {
        // åªä¿å­˜å½“å‰æ–‡ä»¶å¤¹çš„é¡¹ç›®
        const folderProjects = projects.filter(p => p.folderId === currentFolderId);
        folderProjects.forEach(project => {
          project.lastModified = new Date().toISOString();
        });
      } else {
        // ä¿å­˜æ‰€æœ‰é¡¹ç›®
        projects.forEach(project => {
          project.lastModified = new Date().toISOString();
        });
      }
      
      saveProjects();
      unsavedChanges.clear();
      showSaveIndicator('ä¿å­˜æˆåŠŸï¼');
      addLog(`ä¿å­˜äº†${currentFolderId ? 'å½“å‰æ–‡ä»¶å¤¹' : 'æ‰€æœ‰'}é¡¹ç›®`);
    }

    function updateFolderProjectCounts() {
      folders.forEach(folder => {
        folder.projectCount = projects.filter(p => p.folderId === folder.id).length;
      });
      saveFolders();
    }

    function addSampleData() {
      // åˆ›å»ºä¸¤ä¸ªç¤ºä¾‹æ–‡ä»¶å¤¹
      const folderA = {
        id: generateId(),
        name: 'Aé¡¹ç›®',
        description: 'Aé¡¹ç›®åŒ…å«125ä¸ªå®¶å…·é¡¹ç›®',
        created: new Date().toISOString(),
        projectCount: 0
      };
      
      const folderB = {
        id: generateId(),
        name: 'Bé¡¹ç›®',
        description: 'Bé¡¹ç›®åŒ…å«80ä¸ªå®¶å…·é¡¹ç›®',
        created: new Date().toISOString(),
        projectCount: 0
      };
      
      folders.push(folderA, folderB);
      saveFolders();
      
      // ä¸ºæ¯ä¸ªæ–‡ä»¶å¤¹æ·»åŠ ç¤ºä¾‹é¡¹ç›®
      const sampleTypes = ['æ¤…å­', 'æ¡Œå­', 'æ²™å‘', 'åºŠ', 'æŸœå­'];
      
      // ä¸ºAæ–‡ä»¶å¤¹æ·»åŠ 125ä¸ªé¡¹ç›®
      for (let i = 1; i <= 125; i++) {
        const project = {
          id: `A-${String(i).padStart(3, '0')}`,
          customer: `å®¢æˆ·A-${i}`,
          type: sampleTypes[Math.floor(Math.random() * sampleTypes.length)],
          quantity: Math.floor(Math.random() * 20) + 1,
          progress: Math.floor(Math.random() * 101).toString(),
          progressImg: '',
          progressImgUpdatedAt: '',
          deadline: new Date(Date.now() + Math.floor(Math.random() * 90) * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          notes: `Aé¡¹ç›®ç¬¬${i}ä¸ªå®¶å…·`,
          folderId: folderA.id,
          lastModified: new Date().toISOString(),
          folderPath: `Aé¡¹ç›®/${folderA.id}`
        };
        projects.push(project);
      }
      
      // ä¸ºBæ–‡ä»¶å¤¹æ·»åŠ 80ä¸ªé¡¹ç›®
      for (let i = 1; i <= 80; i++) {
        const project = {
          id: `B-${String(i).padStart(3, '0')}`,
          customer: `å®¢æˆ·B-${i}`,
          type: sampleTypes[Math.floor(Math.random() * sampleTypes.length)],
          quantity: Math.floor(Math.random() * 15) + 1,
          progress: Math.floor(Math.random() * 101).toString(),
          progressImg: '',
          progressImgUpdatedAt: '',
          deadline: new Date(Date.now() + Math.floor(Math.random() * 120) * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          notes: `Bé¡¹ç›®ç¬¬${i}ä¸ªå®¶å…·`,
          folderId: folderB.id,
          lastModified: new Date().toISOString(),
          folderPath: `Bé¡¹ç›®/${folderB.id}`
        };
        projects.push(project);
      }
      
      // æ›´æ–°æ–‡ä»¶å¤¹è®¡æ•°å¹¶ä¿å­˜
      updateFolderProjectCounts();
      saveProjects();
      addLog('åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®ï¼šAé¡¹ç›®(125ä¸ª) + Bé¡¹ç›®(80ä¸ª)');
    }

    function setupEventListeners() {
      document.getElementById('searchInput').addEventListener('input', handleSearch);
      
      channel.onmessage = (e) => {
        if (e.data.type === 'update') {
          folders = e.data.folders;
          projects = e.data.projects;
          renderFolders();
          renderTable();
          renderTypeFilters();
          renderStats();
        }
      };
    }

    function handleSearch() {
      currentSearch = document.getElementById('searchInput').value.toLowerCase().trim();
      renderTable(currentFilterType, currentSearch);
    }

    function renderFolders() {
      const foldersList = document.getElementById('foldersList');
      foldersList.innerHTML = '';
      
      // æ·»åŠ "å…¨éƒ¨"é€‰é¡¹
      const allItem = document.createElement('div');
      allItem.className = currentFolderId === '' ? 'folder-item active' : 'folder-item';
      allItem.innerHTML = `
        <div class="folder-name">æ‰€æœ‰é¡¹ç›®</div>
        <div class="folder-count">${projects.length}</div>
      `;
      allItem.onclick = () => selectFolder('');
      foldersList.appendChild(allItem);
      
      // æ·»åŠ åˆ†éš”çº¿
      const divider = document.createElement('div');
      divider.style.height = '1px';
      divider.style.background = 'var(--line)';
      divider.style.margin = '8px 0';
      foldersList.appendChild(divider);
      
      // æ¸²æŸ“æ–‡ä»¶å¤¹åˆ—è¡¨
      folders.forEach(folder => {
        const folderItem = document.createElement('div');
        folderItem.className = currentFolderId === folder.id ? 'folder-item active' : 'folder-item';
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºé»˜è®¤æ–‡ä»¶å¤¹ï¼ˆä¸èƒ½åˆ é™¤ï¼‰
        const isDefaultFolder = folder.id === 'default';
        
        folderItem.innerHTML = `
          <div>
            <div class="folder-name">${folder.name}</div>
            <div class="folder-info" style="font-size:11px;">${folder.description || 'æ— æè¿°'}</div>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <div class="folder-count">${folder.projectCount || 0}</div>
            ${!isDefaultFolder ? '<button class="delete-folder-btn" title="åˆ é™¤æ–‡ä»¶å¤¹">Ã—</button>' : ''}
          </div>
        `;
        
        // ç‚¹å‡»æ–‡ä»¶å¤¹é€‰æ‹©
        folderItem.querySelector('.folder-name, .folder-info').onclick = () => selectFolder(folder.id);
        
        // å³é”®èœå•
        folderItem.oncontextmenu = (e) => {
          e.preventDefault();
          showFolderContextMenu(e, folder);
        };
        
        // åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        if (!isDefaultFolder) {
          const deleteBtn = folderItem.querySelector('.delete-folder-btn');
          deleteBtn.onclick = (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            deleteFolder(folder.id);
          };
        }
        
        foldersList.appendChild(folderItem);
      });
    }

    function selectFolder(folderId) {
      currentFolderId = folderId;
      selectedProjects.clear(); // æ¸…é™¤é€‰æ‹©
      updateBatchActions();
      renderFolders();
      
      // æ›´æ–°æ ‡é¢˜
      const title = document.getElementById('currentFolderTitle');
      if (folderId === '') {
        title.textContent = 'æ‰€æœ‰é¡¹ç›®';
      } else {
        const folder = folders.find(f => f.id === folderId);
        title.textContent = `${folder.name} (${folder.projectCount}ä¸ªé¡¹ç›®)`;
      }
      
      renderTable();
      renderStats();
      renderTypeFilters();
    }

    function showFolderContextMenu(e, folder) {
      // å¦‚æœå³é”®ç‚¹å‡»çš„æ˜¯é»˜è®¤æ–‡ä»¶å¤¹ï¼Œä¸å…è®¸åˆ é™¤
      const isDefaultFolder = folder.id === 'default';
      
      // è·å–æ–‡ä»¶å¤¹ä¸­çš„é¡¹ç›®æ•°é‡
      const projectCount = folder.projectCount || 0;
      
      // æ„å»ºé€‰é¡¹èœå•
      let options = 'è¯·é€‰æ‹©æ“ä½œï¼š\n\n';
      options += '1. é‡å‘½å\n';
      if (!isDefaultFolder) {
        options += '2. åˆ é™¤æ–‡ä»¶å¤¹\n';
      }
      if (projectCount > 0) {
        options += '3. æ¸…ç©ºæ–‡ä»¶å¤¹ï¼ˆé¡¹ç›®ç§»åˆ°"æ‰€æœ‰é¡¹ç›®"ï¼‰\n';
      }
      options += '4. å¯¼å‡ºæ–‡ä»¶å¤¹é¡¹ç›®\n';
      options += '\nè¯·è¾“å…¥é€‰é¡¹ç¼–å·ï¼š';
      
      const userChoice = prompt(options, '1');
      
      if (userChoice === null) return; // ç”¨æˆ·å–æ¶ˆ
      
      switch (userChoice.trim()) {
        case '1':
          renameFolder(folder);
          break;
        case '2':
          if (!isDefaultFolder) {
            deleteFolder(folder.id);
          }
          break;
        case '3':
          if (projectCount > 0) {
            clearFolder(folder.id);
          }
          break;
        case '4':
          exportFolderProjects(folder.id);
          break;
        default:
          // æ— æ•ˆè¾“å…¥ï¼Œä»€ä¹ˆä¹Ÿä¸åš
          break;
      }
    }

    function renameFolder(folder) {
      const newName = prompt(`é‡å‘½åæ–‡ä»¶å¤¹ "${folder.name}"ï¼š`, folder.name);
      if (newName && newName.trim() !== '') {
        const newDescription = prompt(`è¾“å…¥æ–‡ä»¶å¤¹æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š`, folder.description || '');
        folder.name = newName.trim();
        if (newDescription !== null) {
          folder.description = newDescription.trim();
        }
        saveFolders();
        renderFolders();
        addLog(`é‡å‘½åæ–‡ä»¶å¤¹ï¼š${folder.name}`);
      }
    }

    function deleteFolder(folderId) {
      // æ‰¾åˆ°è¦åˆ é™¤çš„æ–‡ä»¶å¤¹
      const folder = folders.find(f => f.id === folderId);
      if (!folder) return;
      
      // æ£€æŸ¥æ–‡ä»¶å¤¹ä¸­æ˜¯å¦æœ‰é¡¹ç›®
      const folderProjects = projects.filter(p => p.folderId === folderId);
      
      let message = `ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ "${folder.name}" å—ï¼Ÿ\n\n`;
      
      if (folderProjects.length > 0) {
        message += `è¯¥æ–‡ä»¶å¤¹åŒ…å« ${folderProjects.length} ä¸ªé¡¹ç›®ï¼Œåˆ é™¤åï¼š\n`;
        message += `1. æ‰€æœ‰é¡¹ç›®å°†ç§»åŠ¨åˆ°"æ‰€æœ‰é¡¹ç›®"ä¸­\n`;
        message += `2. æ–‡ä»¶å¤¹å°†è¢«æ°¸ä¹…åˆ é™¤\n\n`;
        message += `ç¡®è®¤åˆ é™¤å—ï¼Ÿ`;
      } else {
        message += `è¿™æ˜¯ä¸€ä¸ªç©ºæ–‡ä»¶å¤¹ï¼Œç¡®è®¤åˆ é™¤å—ï¼Ÿ`;
      }
      
      if (!confirm(message)) return;
      
      // å°†æ–‡ä»¶å¤¹ä¸­çš„é¡¹ç›®ç§»åŠ¨åˆ°"æ‰€æœ‰é¡¹ç›®"ï¼ˆå³æ¸…é™¤folderIdï¼‰
      projects.forEach(project => {
        if (project.folderId === folderId) {
          project.folderId = '';
          project.folderPath = '';
        }
      });
      
      // åˆ é™¤æ–‡ä»¶å¤¹
      const folderIndex = folders.findIndex(f => f.id === folderId);
      if (folderIndex > -1) {
        folders.splice(folderIndex, 1);
      }
      
      // ä¿å­˜æ•°æ®
      saveFolders();
      saveProjects();
      
      // å¦‚æœå½“å‰é€‰ä¸­çš„å°±æ˜¯è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œåˆ‡æ¢åˆ°æ‰€æœ‰é¡¹ç›®
      if (currentFolderId === folderId) {
        selectFolder('');
      }
      
      // æ›´æ–°ç•Œé¢
      renderFolders();
      renderTable();
      renderStats();
      renderTypeFilters();
      
      addLog(`åˆ é™¤æ–‡ä»¶å¤¹"${folder.name}"ï¼Œ${folderProjects.length}ä¸ªé¡¹ç›®å·²ç§»åŠ¨åˆ°"æ‰€æœ‰é¡¹ç›®"`);
      showSaveIndicator(`å·²åˆ é™¤æ–‡ä»¶å¤¹"${folder.name}"`);
    }

    function clearFolder(folderId) {
      const folder = folders.find(f => f.id === folderId);
      if (!folder) return;
      
      const folderProjects = projects.filter(p => p.folderId === folderId);
      
      if (folderProjects.length === 0) {
        alert('è¯¥æ–‡ä»¶å¤¹å·²ç»æ˜¯ç©ºçš„ï¼');
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦æ¸…ç©ºæ–‡ä»¶å¤¹ "${folder.name}" å—ï¼Ÿ\n\nè¿™å°†æŠŠ ${folderProjects.length} ä¸ªé¡¹ç›®ç§»åŠ¨åˆ°"æ‰€æœ‰é¡¹ç›®"ä¸­ã€‚`)) {
        return;
      }
      
      // å°†æ–‡ä»¶å¤¹ä¸­çš„é¡¹ç›®ç§»åŠ¨åˆ°"æ‰€æœ‰é¡¹ç›®"
      projects.forEach(project => {
        if (project.folderId === folderId) {
          project.folderId = '';
          project.folderPath = '';
        }
      });
      
      // æ›´æ–°æ–‡ä»¶å¤¹è®¡æ•°
      updateFolderProjectCounts();
      saveProjects();
      
      // æ›´æ–°ç•Œé¢
      if (currentFolderId === folderId) {
        renderTable();
        renderStats();
      }
      
      renderFolders();
      renderTypeFilters();
      
      addLog(`æ¸…ç©ºæ–‡ä»¶å¤¹"${folder.name}"ï¼Œ${folderProjects.length}ä¸ªé¡¹ç›®å·²ç§»åŠ¨åˆ°"æ‰€æœ‰é¡¹ç›®"`);
      showSaveIndicator(`å·²æ¸…ç©ºæ–‡ä»¶å¤¹"${folder.name}"`);
    }

    function exportFolderProjects(folderId) {
      const folder = folders.find(f => f.id === folderId);
      const folderProjects = projects.filter(p => p.folderId === folderId);
      
      if (folderProjects.length === 0) {
        alert('è¯¥æ–‡ä»¶å¤¹æ²¡æœ‰é¡¹ç›®å¯å¯¼å‡ºï¼');
        return;
      }
      
      const dataStr = JSON.stringify(folderProjects, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${folder.name}_é¡¹ç›®_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      addLog(`å¯¼å‡ºæ–‡ä»¶å¤¹"${folder.name}"çš„${folderProjects.length}ä¸ªé¡¹ç›®`);
    }

    function showNewFolderDialog() {
      document.getElementById('folderName').value = '';
      document.getElementById('folderDescription').value = '';
      document.getElementById('newFolderDlg').showModal();
    }

    function createNewFolder() {
      const nameInput = document.getElementById('folderName');
      const descInput = document.getElementById('folderDescription');
      
      const name = nameInput.value.trim();
      const description = descInput.value.trim();
      
      if (!name) {
        alert('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°ï¼');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶å¤¹
      if (folders.some(f => f.name === name)) {
        alert('å·²å­˜åœ¨åŒåçš„æ–‡ä»¶å¤¹ï¼');
        return;
      }
      
      const newFolder = {
        id: generateId(),
        name: name,
        description: description,
        created: new Date().toISOString(),
        projectCount: 0
      };
      
      folders.push(newFolder);
      saveFolders();
      renderFolders();
      selectFolder(newFolder.id);
      document.getElementById('newFolderDlg').close();
      addLog(`æ–°å»ºæ–‡ä»¶å¤¹ï¼š${name}`);
    }

    function markAsUnsaved(projectId) {
      unsavedChanges.add(projectId);
      updateSaveButtonState();
    }

    function updateSaveButtonState() {
      const saveBtn = document.querySelector('.btn.success');
      if (unsavedChanges.size > 0) {
        saveBtn.textContent = `ä¿å­˜ä¿®æ”¹(${unsavedChanges.size})`;
        saveBtn.classList.add('warning');
        saveBtn.classList.remove('success');
      } else {
        saveBtn.textContent = 'ä¿å­˜å½“å‰æ–‡ä»¶å¤¹';
        saveBtn.classList.add('success');
        saveBtn.classList.remove('warning');
      }
    }

    function checkUnsavedChanges() {
      if (unsavedChanges.size > 0) {
        showSaveIndicator(`æœ‰ ${unsavedChanges.size} ä¸ªæœªä¿å­˜çš„ä¿®æ”¹`, true);
      }
    }

    function showSaveIndicator(message, isWarning = false) {
      const indicator = document.getElementById('saveIndicator');
      indicator.textContent = message;
      indicator.className = 'save-indicator show';
      if (isWarning) {
        indicator.classList.add('unsaved-warning');
      }
      
      setTimeout(() => {
        indicator.classList.remove('show');
        setTimeout(() => {
          indicator.classList.remove('unsaved-warning');
        }, 300);
      }, 3000);
    }

    function addLog(message) {
      const time = new Date().toLocaleString();
      log.unshift({ time, message });
      if (log.length > 50) log.pop(); // åªä¿ç•™æœ€è¿‘50æ¡
      renderLog();
      channel.postMessage({ type: 'log', log });
    }

    function renderLog() {
      const logContainer = document.getElementById('log');
      logContainer.innerHTML = log.map(item => `
        <div class="logitem">
          <div class="head">
            <div class="msg">${item.message}</div>
            <div class="who">${item.time}</div>
          </div>
        </div>
      `).join('');
    }

    function clearLog() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å˜æ›´è®°å½•å—ï¼Ÿ')) {
        log.length = 0;
        renderLog();
        addLog('æ¸…ç©ºå˜æ›´è®°å½•');
      }
    }

    function renderStats() {
      let filteredProjects;
      if (currentFolderId) {
        filteredProjects = projects.filter(p => p.folderId === currentFolderId);
      } else {
        filteredProjects = projects;
      }
      
      const total = filteredProjects.length;
      const completed = filteredProjects.filter(p => parseInt(p.progress) === 100).length;
      const inProgress = filteredProjects.filter(p => parseInt(p.progress) > 0 && parseInt(p.progress) < 100).length;
      const now = new Date();
      const overdue = filteredProjects.filter(p => {
        if (!p.deadline) return false;
        const deadline = new Date(p.deadline);
        return deadline < now && parseInt(p.progress) < 100;
      }).length;

      document.getElementById('total').textContent = total;
      document.getElementById('completed').textContent = completed;
      document.getElementById('inProgress').textContent = inProgress;
      document.getElementById('overdue').textContent = overdue;
    }

    function renderTypeFilters() {
      const container = document.getElementById('typeFilters');
      container.innerHTML = '';
      
      let filteredProjects;
      if (currentFolderId) {
        filteredProjects = projects.filter(p => p.folderId === currentFolderId);
      } else {
        filteredProjects = projects;
      }
      
      const allChip = document.createElement('div');
      allChip.className = currentFilterType === '' ? 'filter-chip active' : 'filter-chip';
      allChip.textContent = 'å…¨éƒ¨';
      allChip.onclick = () => {
        currentFilterType = '';
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        allChip.classList.add('active');
        renderTable(currentFilterType, currentSearch);
      };
      container.appendChild(allChip);
      
      const types = [...new Set(filteredProjects.map(p => p.type).filter(Boolean))];
      types.forEach(type => {
        const chip = document.createElement('div');
        chip.className = currentFilterType === type ? 'filter-chip active' : 'filter-chip';
        chip.textContent = type;
        chip.onclick = () => {
          currentFilterType = type;
          document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          renderTable(currentFilterType, currentSearch);
        };
        container.appendChild(chip);
      });
    }

    function clearFilters() {
      currentFilterType = '';
      currentSearch = '';
      document.getElementById('searchInput').value = '';
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      if (document.querySelectorAll('.filter-chip')[0]) {
        document.querySelectorAll('.filter-chip')[0].classList.add('active');
      }
      renderTable();
    }

    function renderTable(filterType = '', search = '') {
      const tbody = document.querySelector('#projectTable tbody');
      tbody.innerHTML = '';

      // ç­›é€‰é¡¹ç›®
      let filteredProjects;
      if (currentFolderId) {
        filteredProjects = projects.filter(p => p.folderId === currentFolderId);
      } else {
        filteredProjects = projects;
      }

      // è¿›ä¸€æ­¥ç­›é€‰
      filteredProjects = filteredProjects.filter(p => {
        const matchType = !filterType || p.type === filterType;
        const matchSearch = !search || 
          (p.customer && p.customer.toLowerCase().includes(search)) ||
          (p.id && p.id.toLowerCase().includes(search)) ||
          (p.type && p.type.toLowerCase().includes(search));
        return matchType && matchSearch;
      });

      filteredProjects.forEach((project, index) => {
        const tr = document.createElement('tr');
        tr.dataset.projectId = project.id;

        // å¤é€‰æ¡†åˆ—
        const tdCheckbox = document.createElement('td');
        tdCheckbox.className = 'checkbox-cell';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = selectedProjects.has(project.id);
        checkbox.onchange = (e) => {
          if (e.target.checked) {
            selectedProjects.add(project.id);
          } else {
            selectedProjects.delete(project.id);
          }
          updateBatchActions();
        };
        tdCheckbox.appendChild(checkbox);
        tr.appendChild(tdCheckbox);

        // é¡¹ç›®ç¼–å·ï¼ˆå¸¦æ–‡ä»¶å¤¹ä¿¡æ¯ï¼‰
        const td1 = document.createElement('td');
        const folder = folders.find(f => f.id === project.folderId);
        td1.innerHTML = `
          <div>${project.id}</div>
          <div class="folder-info">
            <span class="folder-icon">${folder ? 'ğŸ“' : 'ğŸ“„'}</span>
            <span>${folder ? folder.name : 'æœªåˆ†ç±»'}</span>
          </div>
        `;
        tr.appendChild(td1);

        // å®¢æˆ·åç§°
        const td2 = createEditableCell(project, 'customer');
        tr.appendChild(td2);

        // å®¶å…·ç±»å‹
        const td3 = createTypeEditableCell(project);
        tr.appendChild(td3);

        // æ•°é‡ - ä¿®å¤æ˜¾ç¤ºé—®é¢˜
        const td4 = createEditableCell(project, 'quantity', 'number');
        tr.appendChild(td4);

        // è¿›åº¦
        const td5 = createProgressCell(project);
        tr.appendChild(td5);

        // è¿›åº¦å›¾ç‰‡
        const td6 = createProgressImageCell(project);
        tr.appendChild(td6);

        // äº¤è´§æ—¥æœŸ
        const td7 = createEditableCell(project, 'deadline', 'date');
        tr.appendChild(td7);

        // å¤‡æ³¨
        const td8 = createEditableCell(project, 'notes', 'textarea');
        tr.appendChild(td8);

        // æ“ä½œ
        const td9 = document.createElement('td');
        td9.className = 'row-actions';
        
        const saveBtn = document.createElement('button');
        saveBtn.className = unsavedChanges.has(project.id) ? 'btn warning' : 'btn success';
        saveBtn.textContent = unsavedChanges.has(project.id) ? 'ä¿å­˜' : 'å·²ä¿å­˜';
        saveBtn.onclick = () => saveSingleProject(project);
        
        const moveBtn = document.createElement('button');
        moveBtn.className = 'btn';
        moveBtn.textContent = 'ç§»åŠ¨';
        moveBtn.title = 'ç§»åŠ¨åˆ°å…¶ä»–æ–‡ä»¶å¤¹';
        moveBtn.onclick = () => moveProjectToFolder(project);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn danger';
        deleteBtn.textContent = 'åˆ é™¤';
        deleteBtn.onclick = () => deleteProject(project);
        
        td9.appendChild(saveBtn);
        td9.appendChild(moveBtn);
        td9.appendChild(deleteBtn);
        tr.appendChild(td9);

        tbody.appendChild(tr);
      });
      
      updateSaveButtonState();
      updateBatchActions();
    }

    function createEditableCell(project, field, type = 'text') {
      const td = document.createElement('td');
      
     if (type === 'textarea') {
  const textarea = document.createElement('textarea');
  textarea.value = project[field] || '';
  textarea.style.resize = 'both';
  textarea.style.minWidth = '150px';
  textarea.style.minHeight = '60px';
  textarea.style.maxWidth = '400px';
  textarea.style.maxHeight = '200px';
  
  textarea.addEventListener('blur', () => {
    if (textarea.value !== project[field]) {
      project[field] = textarea.value;
      markAsUnsaved(project.id);
      addLog(`ä¿®æ”¹é¡¹ç›® ${project.id} çš„${getFieldName(field)}`);
    }
  });
  
  td.appendChild(textarea);
  return td;
}

      if (type === 'number') {
        const input = document.createElement('input');
        input.type = 'number';
        input.min = '1';
        input.value = project[field] || '';
        input.className = 'quantity-input';
        input.addEventListener('blur', () => {
          const newValue = parseInt(input.value) || 0;
          if (newValue !== project[field]) {
            project[field] = newValue;
            markAsUnsaved(project.id);
            addLog(`ä¿®æ”¹é¡¹ç›® ${project.id} çš„${getFieldName(field)}`);
          }
        });
        td.appendChild(input);
        return td;
      }

      if (type === 'date') {
        const input = document.createElement('input');
        input.type = 'date';
        input.value = project[field] || '';
        input.addEventListener('blur', () => {
          if (input.value !== project[field]) {
            project[field] = input.value;
            markAsUnsaved(project.id);
            addLog(`ä¿®æ”¹é¡¹ç›® ${project.id} çš„${getFieldName(field)}`);
          }
        });
        td.appendChild(input);
        return td;
      }

      const input = document.createElement('input');
      input.type = 'text';
      input.value = project[field] || '';
      input.addEventListener('blur', () => {
        if (input.value !== project[field]) {
          project[field] = input.value;
          markAsUnsaved(project.id);
          addLog(`ä¿®æ”¹é¡¹ç›® ${project.id} çš„${getFieldName(field)}`);
        }
      });
      td.appendChild(input);
      return td;
    }

    function createTypeEditableCell(project) {
      const td = document.createElement('td');
      
      const existingTypes = [...new Set(projects.map(p => p.type).filter(Boolean))];
      const defaultTypes = ['æ¤…å­', 'æ¡Œå­', 'æ²™å‘', 'åºŠ', 'æŸœå­', 'ä¹¦æ¶', 'èŒ¶å‡ ', 'åŠå…¬æ¤…', 'é¤æ¡Œ', 'ç”µè§†æŸœ'];
      const allTypes = [...new Set([...defaultTypes, ...existingTypes])];
      
      const select = document.createElement('select');
      allTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        if (type === project.type) {
          option.selected = true;
        }
        select.appendChild(option);
      });
      
      const customOption = document.createElement('option');
      customOption.value = 'custom';
      customOption.textContent = 'è‡ªå®šä¹‰...';
      if (!allTypes.includes(project.type) && project.type) {
        customOption.selected = true;
      }
      select.appendChild(customOption);
      
      select.addEventListener('change', () => {
        if (select.value === 'custom') {
          const newType = prompt('è¯·è¾“å…¥æ–°çš„å®¶å…·ç±»å‹ï¼š', project.type || '');
          if (newType !== null && newType.trim() !== '') {
            const oldValue = project.type;
            project.type = newType.trim();
            markAsUnsaved(project.id);
            addLog(`ä¿®æ”¹é¡¹ç›® ${project.id} çš„å®¶å…·ç±»å‹`);
            renderTable(currentFilterType, currentSearch);
            renderTypeFilters();
          } else {
            select.value = project.type || '';
          }
        } else if (select.value !== project.type) {
          const oldValue = project.type;
          project.type = select.value;
          markAsUnsaved(project.id);
          addLog(`ä¿®æ”¹é¡¹ç›® ${project.id} çš„å®¶å…·ç±»å‹`);
          renderTable(currentFilterType, currentSearch);
          renderTypeFilters();
        }
      });
      
      td.appendChild(select);
      return td;
    }

    function createProgressCell(project) {
      const td = document.createElement('td');
      const progress = parseInt(project.progress) || 0;
      
      const input = document.createElement('input');
      input.type = 'range';
      input.min = '0';
      input.max = '100';
      input.value = progress;
      input.style.width = '80px';
      
      const span = document.createElement('span');
      span.textContent = ` ${progress}%`;
      span.style.marginLeft = '8px';
      
      input.style.background = progress === 100 ? 'var(--success)' : 
                               progress >= 50 ? 'var(--warning)' : 'var(--danger)';
      
      input.addEventListener('input', () => {
        const newProgress = parseInt(input.value);
        span.textContent = ` ${newProgress}%`;
        input.style.background = newProgress === 100 ? 'var(--success)' : 
                                 newProgress >= 50 ? 'var(--warning)' : 'var(--danger)';
      });
      
      input.addEventListener('change', () => {
        const newProgress = parseInt(input.value);
        if (newProgress !== parseInt(project.progress || 0)) {
          const oldValue = project.progress;
          project.progress = newProgress.toString();
          markAsUnsaved(project.id);
          addLog(`ä¿®æ”¹é¡¹ç›® ${project.id} çš„è¿›åº¦`);
        }
      });
      
      td.appendChild(input);
      td.appendChild(span);
      return td;
    }

    function createProgressImageCell(project) {
      const td = document.createElement('td');
      const wrap = document.createElement('div');
      wrap.className = 'img-actions';

      if (project.progressImg) {
        const img = document.createElement('img');
        img.className = 'thumb';
        img.src = project.progressImg;
        img.title = 'ç‚¹å‡»é¢„è§ˆ';
        img.onclick = () => openImagePreview(project);
        wrap.appendChild(img);
      } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'thumb';
        placeholder.style.display = 'flex';
        placeholder.style.alignItems = 'center';
        placeholder.style.justifyContent = 'center';
        placeholder.style.color = 'rgba(255,255,255,.45)';
        placeholder.style.fontSize = '12px';
        placeholder.textContent = 'æš‚æ— ';
        wrap.appendChild(placeholder);
      }

      const uploadBtn = document.createElement('button');
      uploadBtn.className = 'btn';
      uploadBtn.textContent = project.progressImg ? 'æ›´æ–°' : 'ä¸Šä¼ ';
      uploadBtn.onclick = () => showUploadOptions(project);
      wrap.appendChild(uploadBtn);

      if (project.progressImg) {
        const clearBtn = document.createElement('button');
        clearBtn.className = 'btn danger';
        clearBtn.textContent = 'æ¸…é™¤';
        clearBtn.onclick = () => {
          if (!confirm('ç¡®å®šæ¸…é™¤è¯¥é¡¹ç›®çš„è¿›å±•å›¾ç‰‡å—ï¼Ÿ')) return;
          project.progressImg = '';
          project.progressImgUpdatedAt = '';
          markAsUnsaved(project.id);
          addLog(`æ¸…é™¤é¡¹ç›® ${project.id} çš„è¿›å±•å›¾ç‰‡`);
          renderTable(currentFilterType, currentSearch);
        };
        wrap.appendChild(clearBtn);
      }

      td.appendChild(wrap);
      return td;
    }

    function showUploadOptions(project) {
      // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        // ç§»åŠ¨è®¾å¤‡æ˜¾ç¤ºæ‹ç…§é€‰é¡¹
        const option = prompt('é€‰æ‹©ä¸Šä¼ æ–¹å¼ï¼š\n1. ä»ç›¸å†Œé€‰æ‹©\n2. æ‹ç…§\n\nè¾“å…¥1æˆ–2ï¼š', '1');
        if (option === '1') {
          triggerImageUpload(project);
        } else if (option === '2') {
          openCamera(project);
        }
      } else {
        // æ¡Œé¢è®¾å¤‡ç›´æ¥ä¸Šä¼ 
        triggerImageUpload(project);
      }
    }

    function triggerImageUpload(project) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      
      // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ï¼Œå¯ä»¥è®¾ç½®captureå±æ€§
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if (isMobile) {
        input.capture = 'environment'; // ä½¿ç”¨åç½®æ‘„åƒå¤´
      }

      input.onchange = async () => {
        const file = input.files?.[0];
        if (!file) return;

        const maxBytes = 800 * 1024;
        const dataUrl = await readAndMaybeCompressImage(file, maxBytes);

        project.progressImg = dataUrl;
        project.progressImgUpdatedAt = new Date().toISOString();
        markAsUnsaved(project.id);
        addLog(`æ›´æ–°é¡¹ç›® ${project.id} çš„è¿›å±•å›¾ç‰‡`);

        try {
          renderTable(currentFilterType, currentSearch);
        } catch (e) {
          alert('ä¿å­˜å¤±è´¥ï¼šå¯èƒ½æ˜¯æœ¬åœ°å­˜å‚¨ç©ºé—´ä¸è¶³ã€‚å»ºè®®æ¢å°ä¸€ç‚¹çš„å›¾ç‰‡æˆ–æ”¹ç”¨ IndexedDBã€‚');
          console.error(e);
        }
      };

      input.click();
    }

    function openCamera(project) {
      currentCameraProject = project;
      const dlg = document.getElementById('cameraDlg');
      const video = document.getElementById('cameraPreview');
      
      // è¯·æ±‚æ‘„åƒå¤´æƒé™
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          video.srcObject = stream;
          dlg.showModal();
        })
        .catch(err => {
          alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼š' + err.message);
          // å¦‚æœæ‘„åƒå¤´å¤±è´¥ï¼Œå›é€€åˆ°æ™®é€šä¸Šä¼ 
          triggerImageUpload(project);
        });
    }

    function closeCamera() {
      const dlg = document.getElementById('cameraDlg');
      const video = document.getElementById('cameraPreview');
      const canvas = document.getElementById('cameraCanvas');
      
      // åœæ­¢è§†é¢‘æµ
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      
      dlg.close();
      currentCameraProject = null;
    }

    function capturePhoto() {
      const video = document.getElementById('cameraPreview');
      const canvas = document.getElementById('cameraCanvas');
      const project = currentCameraProject;
      
      if (!project) return;
      
      // è®¾ç½®canvaså°ºå¯¸ä¸è§†é¢‘ä¸€è‡´
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      // åœ¨canvasä¸Šç»˜åˆ¶å½“å‰è§†é¢‘å¸§
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // å°†canvasè½¬æ¢ä¸ºDataURL
      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      
      project.progressImg = dataUrl;
      project.progressImgUpdatedAt = new Date().toISOString();
      markAsUnsaved(project.id);
      addLog(`é€šè¿‡æ‹ç…§æ›´æ–°é¡¹ç›® ${project.id} çš„è¿›å±•å›¾ç‰‡`);
      
      // å…³é—­æ‘„åƒå¤´
      closeCamera();
      
      // æ›´æ–°è¡¨æ ¼
      renderTable(currentFilterType, currentSearch);
      showSaveIndicator('æ‹ç…§æˆåŠŸï¼');
    }

    function openImagePreview(project) {
      const dlg = document.getElementById('imgPreviewDlg');
      const img = document.getElementById('imgPreview');
      const meta = document.getElementById('imgPreviewMeta');

      img.src = project.progressImg || '';
      const t = project.progressImgUpdatedAt
        ? new Date(project.progressImgUpdatedAt).toLocaleString()
        : 'æœªçŸ¥';

      const folder = folders.find(f => f.id === project.folderId);
      meta.textContent = `é¡¹ç›®ï¼š${project.id}  | å®¢æˆ·ï¼š${project.customer || '-'}  | æ–‡ä»¶å¤¹ï¼š${folder ? folder.name : 'æœªåˆ†ç±»'}  | æ›´æ–°æ—¶é—´ï¼š${t}`;
      dlg.showModal();
    }

    function getFieldName(field) {
      switch (field) {
        case 'customer': return 'å®¢æˆ·åç§°';
        case 'type': return 'å®¶å…·ç±»å‹';
        case 'quantity': return 'æ•°é‡';
        case 'deadline': return 'äº¤è´§æ—¥æœŸ';
        case 'notes': return 'å¤‡æ³¨';
        default: return field;
      }
    }

    function saveSingleProject(project) {
      project.lastModified = new Date().toISOString();
      saveProjects();
      unsavedChanges.delete(project.id);
      showSaveIndicator(`é¡¹ç›® ${project.id} å·²ä¿å­˜`);
      renderTable(currentFilterType, currentSearch);
      renderStats();
      updateFolderProjectCounts();
    }

    function moveProjectToFolder(project) {
      let folderOptions = '<option value="">-- ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹ --</option>';
      folders.forEach(folder => {
        if (folder.id !== project.folderId) {
          folderOptions += `<option value="${folder.id}">${folder.name} (${folder.projectCount}ä¸ªé¡¹ç›®)</option>`;
        }
      });
      folderOptions += '<option value="none">-- ç§»åŠ¨åˆ°"æ‰€æœ‰é¡¹ç›®" --</option>';
      
      const folderId = prompt(`å°†é¡¹ç›® ${project.id} ç§»åŠ¨åˆ°ï¼š\n\n${folderOptions}`, project.folderId || 'none');
      
      if (folderId === null) return; // ç”¨æˆ·å–æ¶ˆ
      
      const oldFolder = folders.find(f => f.id === project.folderId);
      const newFolder = folderId === 'none' ? null : folders.find(f => f.id === folderId);
      
      if (newFolder || folderId === 'none') {
        project.folderId = folderId === 'none' ? '' : folderId;
        saveProjects();
        updateFolderProjectCounts();
        renderFolders();
        renderTable(currentFilterType, currentSearch);
        addLog(`ç§»åŠ¨é¡¹ç›® ${project.id} ä»"${oldFolder ? oldFolder.name : 'æ‰€æœ‰é¡¹ç›®'}"åˆ°"${newFolder ? newFolder.name : 'æ‰€æœ‰é¡¹ç›®'}"`);
      }
    }

    function deleteProject(project) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤é¡¹ç›® ${project.id} å—ï¼Ÿ`)) return;
      
      const index = projects.findIndex(p => p.id === project.id);
      if (index > -1) {
        projects.splice(index, 1);
        saveProjects();
        updateFolderProjectCounts();
        renderFolders();
        renderTable(currentFilterType, currentSearch);
        renderStats();
        addLog(`åˆ é™¤é¡¹ç›®ï¼š${project.id}`);
        showSaveIndicator(`é¡¹ç›® ${project.id} å·²åˆ é™¤`);
      }
    }

    // æ‰¹é‡åˆ é™¤åŠŸèƒ½
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('#projectTable tbody input[type="checkbox"]');
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        const projectId = checkbox.closest('tr').dataset.projectId;
        if (selectAll.checked) {
          selectedProjects.add(projectId);
        } else {
          selectedProjects.delete(projectId);
        }
      });
      
      updateBatchActions();
    }

    function toggleHeaderCheckbox() {
      const headerCheckbox = document.getElementById('headerCheckbox');
      const selectAll = document.getElementById('selectAll');
      
      if (selectAll) {
        selectAll.checked = headerCheckbox.checked;
        toggleSelectAll();
      }
    }

    function updateBatchActions() {
      const batchActions = document.getElementById('batchActions');
      const batchDeleteBtn = document.getElementById('batchDeleteBtn');
      const selectedCount = document.getElementById('selectedCount');
      const headerCheckbox = document.getElementById('headerCheckbox');
      
      selectedCount.textContent = `å·²é€‰æ‹© ${selectedProjects.size} ä¸ªé¡¹ç›®`;
      
      if (selectedProjects.size > 0) {
        batchActions.style.display = 'flex';
        batchDeleteBtn.style.display = 'inline-flex';
      } else {
        batchActions.style.display = 'none';
        batchDeleteBtn.style.display = 'none';
      }
      
      // æ›´æ–°è¡¨å¤´å¤é€‰æ¡†çŠ¶æ€
      if (headerCheckbox) {
        const checkboxes = document.querySelectorAll('#projectTable tbody input[type="checkbox"]');
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        headerCheckbox.checked = allChecked;
      }
    }

    function batchDeleteProjects() {
      if (selectedProjects.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®ï¼');
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedProjects.size} ä¸ªé¡¹ç›®å—ï¼Ÿ`)) return;
      
      // åˆ é™¤é€‰ä¸­çš„é¡¹ç›®
      let deletedCount = 0;
      selectedProjects.forEach(projectId => {
        const index = projects.findIndex(p => p.id === projectId);
        if (index > -1) {
          projects.splice(index, 1);
          deletedCount++;
        }
      });
      
      // ä¿å­˜å¹¶æ›´æ–°ç•Œé¢
      saveProjects();
      updateFolderProjectCounts();
      renderFolders();
      selectedProjects.clear();
      renderTable(currentFilterType, currentSearch);
      renderStats();
      addLog(`æ‰¹é‡åˆ é™¤ ${deletedCount} ä¸ªé¡¹ç›®`);
      showSaveIndicator(`å·²åˆ é™¤ ${deletedCount} ä¸ªé¡¹ç›®`);
    }

    function showImport() {
      document.getElementById('fileInput').value = '';
      
      // æ›´æ–°æ–‡ä»¶å¤¹é€‰æ‹©ä¸‹æ‹‰æ¡†
      const folderSelect = document.getElementById('importFolderSelect');
      folderSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ–‡ä»¶å¤¹ --</option>';
      folders.forEach(folder => {
        const option = document.createElement('option');
        option.value = folder.id;
        option.textContent = `${folder.name} (${folder.projectCount}ä¸ªé¡¹ç›®)`;
        folderSelect.appendChild(option);
      });
      
      document.getElementById('importDlg').showModal();
    }

    function importExcel(file) {
      const folderSelect = document.getElementById('importFolderSelect');
      const folderId = folderSelect.value;
      
      if (!folderId) {
        alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥åˆ°çš„æ–‡ä»¶å¤¹ï¼');
        return;
      }
      
      const folder = folders.find(f => f.id === folderId);
      if (!folder) {
        alert('é€‰æ‹©çš„æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheet];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          if (jsonData.length < 2) throw new Error('Excelæ–‡ä»¶æ•°æ®ä¸ºç©º');

          const headers = jsonData[0].map(h => h ? h.toString().trim() : '');
          const fieldMapping = mapHeadersToFields(headers);
          
          let importedCount = 0;
          let skippedCount = 0;
          
          for (let i = 1; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row.every(cell => cell === null || cell === '' || cell === undefined)) continue;
            
            const project = {};
            project.folderId = folderId;
            project.folderPath = `${folder.name}/${folderId}`;
            project.lastModified = new Date().toISOString();
            project.progressImg = '';
            project.progressImgUpdatedAt = '';
            
            // å¤„ç†æ¯ä¸ªå­—æ®µ
            Object.keys(fieldMapping).forEach(field => {
              const headerIndex = fieldMapping[field];
              if (headerIndex !== undefined && row[headerIndex] !== undefined) {
                const value = row[headerIndex];
                switch (field) {
                  case 'id':
                    project.id = value ? value.toString().trim() : generateProjectId();
                    break;
                  case 'customer':
                    project.customer = value ? value.toString().trim() : '';
                    break;
                  case 'type':
                    project.type = value ? value.toString().trim() : '';
                    break;
                  case 'quantity':
                    project.quantity = parseInt(value) || 0;
                    break;
                  case 'progress':
                    project.progress = (parseInt(value) || 0).toString();
                    break;
                  case 'deadline':
                    project.deadline = formatDate(value);
                    break;
                  case 'notes':
                    project.notes = value ? value.toString().trim() : '';
                    break;
                }
              }
            });
            
            // ç¡®ä¿æœ‰é¡¹ç›®ç¼–å·
            if (!project.id) {
              project.id = generateProjectId();
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒé¡¹ç›®ç¼–å·ï¼ˆåœ¨åŒä¸€æ–‡ä»¶å¤¹å†…ï¼‰
            const existingIndex = projects.findIndex(p => p.id === project.id && p.folderId === folderId);
            if (existingIndex > -1) {
              if (confirm(`é¡¹ç›® ${project.id} å·²å­˜åœ¨äºæ–‡ä»¶å¤¹"${folder.name}"ä¸­ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
                projects[existingIndex] = project;
                importedCount++;
              } else {
                project.id = generateProjectId();
                projects.push(project);
                importedCount++;
              }
            } else {
              projects.push(project);
              importedCount++;
            }
          }
          
          // ä¿å­˜å¹¶æ›´æ–°ç•Œé¢
          saveProjects();
          updateFolderProjectCounts();
          renderFolders();
          
          // å¦‚æœå½“å‰é€‰ä¸­çš„å°±æ˜¯è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œåˆ·æ–°è¡¨æ ¼
          if (currentFolderId === folderId) {
            renderTable();
            renderStats();
            renderTypeFilters();
          }
          
          document.getElementById('importDlg').close();
          showSaveIndicator(`æˆåŠŸå¯¼å…¥ ${importedCount} ä¸ªé¡¹ç›®åˆ°"${folder.name}"`);
          addLog(`å¯¼å…¥ ${importedCount} ä¸ªé¡¹ç›®åˆ°æ–‡ä»¶å¤¹"${folder.name}"`);
        } catch (error) {
          alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
          console.error(error);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function mapHeadersToFields(headers) {
      const mapping = {};
      
      headers.forEach((header, index) => {
        const headerLower = header.toLowerCase();
        
        if (PROJECT_ID_KEYWORDS.some(keyword => headerLower.includes(keyword.toLowerCase()))) {
          mapping.id = index;
        } else if (CUSTOMER_KEYWORDS.some(keyword => headerLower.includes(keyword.toLowerCase()))) {
          mapping.customer = index;
        } else if (TYPE_KEYWORDS.some(keyword => headerLower.includes(keyword.toLowerCase()))) {
          mapping.type = index;
        } else if (QUANTITY_KEYWORDS.some(keyword => headerLower.includes(keyword.toLowerCase()))) {
          mapping.quantity = index;
        } else if (PROGRESS_KEYWORDS.some(keyword => headerLower.includes(keyword.toLowerCase()))) {
          mapping.progress = index;
        } else if (DEADLINE_KEYWORDS.some(keyword => headerLower.includes(keyword.toLowerCase()))) {
          mapping.deadline = index;
        } else if (NOTES_KEYWORDS.some(keyword => headerLower.includes(keyword.toLowerCase()))) {
          mapping.notes = index;
        }
      });
      
      return mapping;
    }

    function generateId() {
      return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    function generateProjectId() {
      const now = new Date();
      const timestamp = now.getTime().toString().slice(-6);
      const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      return `PROJ-${timestamp}${random}`;
    }

    function formatDate(value) {
      if (!value) return '';
      try {
        if (typeof value === 'number') {
          const date = new Date(Math.round((value - 25569) * 86400 * 1000));
          return date.toISOString().split('T')[0];
        }
        
        const date = new Date(value);
        if (!isNaN(date.getTime())) {
          return date.toISOString().split('T')[0];
        }
        
        const match = value.toString().match(/(\d{4})[å¹´\/\-](\d{1,2})[æœˆ\/\-](\d{1,2})/);
        if (match) {
          const year = match[1];
          const month = match[2].padStart(2, '0');
          const day = match[3].padStart(2, '0');
          return `${year}-${month}-${day}`;
        }
        
        return value.toString();
      } catch (e) {
        return value ? value.toString() : '';
      }
    }

    function exportJSON() {
      let exportProjects;
      if (currentFolderId) {
        exportProjects = projects.filter(p => p.folderId === currentFolderId);
      } else {
        exportProjects = projects;
      }
      
      const dataStr = JSON.stringify(exportProjects, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      if (currentFolderId) {
        const folder = folders.find(f => f.id === currentFolderId);
        a.download = `${folder.name}_é¡¹ç›®_${new Date().toISOString().split('T')[0]}.json`;
      } else {
        a.download = `æ‰€æœ‰é¡¹ç›®_${new Date().toISOString().split('T')[0]}.json`;
      }
      
      a.click();
      URL.revokeObjectURL(url);
      addLog('å¯¼å‡ºJSONæ•°æ®');
    }

    function exportTableToExcel() {
      try {
        let exportProjects;
        if (currentFolderId) {
          exportProjects = projects.filter(p => p.folderId === currentFolderId);
        } else {
          exportProjects = projects;
        }
        
        const data = [
          ['é¡¹ç›®ç¼–å·', 'å®¢æˆ·åç§°', 'å®¶å…·ç±»å‹', 'æ•°é‡', 'è¿›åº¦(%)', 'äº¤è´§æ—¥æœŸ', 'å¤‡æ³¨', 'æ–‡ä»¶å¤¹', 'æœ€åä¿®æ”¹æ—¶é—´']
        ];
        
        exportProjects.forEach(project => {
          const folder = folders.find(f => f.id === project.folderId);
          data.push([
            project.id,
            project.customer,
            project.type,
            project.quantity,
            project.progress,
            project.deadline,
            project.notes,
            folder ? folder.name : 'æœªåˆ†ç±»',
            project.lastModified ? new Date(project.lastModified).toLocaleString() : ''
          ]);
        });
        
        const worksheet = XLSX.utils.aoa_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        
        let sheetName = 'æ‰€æœ‰é¡¹ç›®';
        if (currentFolderId) {
          const folder = folders.find(f => f.id === currentFolderId);
          sheetName = folder.name;
        }
        
        XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
        
        let fileName = `å®¶å…·é¡¹ç›®_${new Date().toISOString().split('T')[0]}.xlsx`;
        if (currentFolderId) {
          const folder = folders.find(f => f.id === currentFolderId);
          fileName = `${folder.name}_é¡¹ç›®_${new Date().toISOString().split('T')[0]}.xlsx`;
        }
        
        XLSX.writeFile(workbook, fileName);
        addLog('å¯¼å‡ºExcelæ•°æ®');
      } catch (error) {
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
      }
    }

    function addNewProject() {
      let folderId = currentFolderId;
      
      // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡ä»¶å¤¹ï¼Œè®©ç”¨æˆ·é€‰æ‹©
      if (!folderId && folders.length > 0) {
        let folderOptions = 'è¯·é€‰æ‹©è¦æ·»åŠ åˆ°çš„æ–‡ä»¶å¤¹ï¼š\n\n';
        folders.forEach((folder, index) => {
          folderOptions += `${index + 1}. ${folder.name} (${folder.projectCount}ä¸ªé¡¹ç›®)\n`;
        });
        folderOptions += `\nè¾“å…¥æ–‡ä»¶å¤¹ç¼–å·ï¼ˆ1-${folders.length}ï¼‰ï¼Œæˆ–æŒ‰å–æ¶ˆæ·»åŠ åˆ°"æ‰€æœ‰é¡¹ç›®"ï¼š`;
        
        const choice = prompt(folderOptions, '1');
        if (choice === null) return; // ç”¨æˆ·å–æ¶ˆ
        
        const index = parseInt(choice) - 1;
        if (index >= 0 && index < folders.length) {
          folderId = folders[index].id;
        }
        // å¦‚æœè¾“å…¥æ— æ•ˆï¼ŒfolderIdä¿æŒä¸ºç©ºï¼ˆå³æ·»åŠ åˆ°"æ‰€æœ‰é¡¹ç›®"ï¼‰
      }
      
      const folder = folders.find(f => f.id === folderId);
      
      const newProject = {
        id: generateProjectId(),
        customer: 'æ–°å®¢æˆ·',
        type: 'æ¤…å­',
        quantity: 10,
        progress: '0',
        progressImg: '',
        progressImgUpdatedAt: '',
        deadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        notes: '',
        folderId: folderId || '',
        lastModified: new Date().toISOString(),
        folderPath: folder ? `${folder.name}/${folderId}` : ''
      };
      
      projects.unshift(newProject);
      saveProjects();
      updateFolderProjectCounts();
      renderFolders();
      
      // å¦‚æœæ–°å»ºçš„é¡¹ç›®åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸­ï¼Œåˆ·æ–°è¡¨æ ¼
      if (currentFolderId === folderId || (!currentFolderId && !folderId)) {
        renderTable();
        renderStats();
        renderTypeFilters();
      }
      
      addLog(`æ–°å¢é¡¹ç›®ï¼š${newProject.id} - ${newProject.customer}`);
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function readAndMaybeCompressImage(file, maxBytes) {
      const original = await readFileAsDataURL(file);
      if (file.size <= maxBytes) return original;

      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.onload = () => resolve(i);
        i.onerror = reject;
        i.src = original;
      });

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const maxSide = 1200;
      let { width, height } = img;
      const scale = Math.min(1, maxSide / Math.max(width, height));
      width = Math.round(width * scale);
      height = Math.round(height * scale);

      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);

      let quality = 0.85;
      let out = canvas.toDataURL('image/jpeg', quality);
      while (out.length > maxBytes * 1.37 && quality > 0.45) {
        quality -= 0.1;
        out = canvas.toDataURL('image/jpeg', quality);
      }
      return out;
    }

    // åˆå§‹åŒ–
    function init() {
      loadData();
      setupEventListeners();
      renderFolders();
      renderStats();
      renderTypeFilters();
      renderTable();
      renderLog();
      
      // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
      setInterval(checkUnsavedChanges, 30000);
      
      // åˆå§‹åŒ–åä½œåŠŸèƒ½
      collaborationManager = new CollaborationManager();
      collaborationManager.initialize();
    }
    
    // å¯åŠ¨åº”ç”¨
    document.addEventListener('DOMContentLoaded', init);
    
    // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
    document.getElementById('fileInput')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const folderSelect = document.getElementById('importFolderSelect');
        if (!folderSelect.value) {
          alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥åˆ°çš„æ–‡ä»¶å¤¹ï¼');
          return;
        }
        importExcel(file);
      }
    });

    document.getElementById('dropZone')?.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.target.style.borderColor = 'var(--primary)';
    });

    document.getElementById('dropZone')?.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.target.style.borderColor = 'var(--line)';
    });

    document.getElementById('dropZone')?.addEventListener('drop', (e) => {
      e.preventDefault();
      e.target.style.borderColor = 'var(--line)';
      const file = e.dataTransfer.files[0];
      if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
        const folderSelect = document.getElementById('importFolderSelect');
        if (!folderSelect.value) {
          alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥åˆ°çš„æ–‡ä»¶å¤¹ï¼');
          return;
        }
        importExcel(file);
      } else {
        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰');
      }
    });
  </script>
</body>
</html>
